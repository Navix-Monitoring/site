<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Saúde do Lote</title>

  <!-- Tailwind (necessário para as classes usadas no HTML) -->
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <link rel="stylesheet" href="../css/dashboard.css" />
</head>

<body class="bg-gray-100">
  <div class="flex flex-row w-full">
    <!-- NAV -->
    <div
      class="min-h-screen w-[250px] flex flex-col items-center bg-slate-100 py-6 shadow-2xl shadow-slate-600 fixed top-0 left-0">
      <img src="../assets/img/Logo.png" class="w-[120px] h-[60px] mb-10" />
      <div id="imagemUsuarioNavbar">
        <div class="rounded-md w-20 h-20 mb-2"
          style="background-image: url(../assets/img/foto-usuario.png); background-size: cover;"></div>
      </div>
      <div id="nomeProfissao" class="text-center mb-6"></div>
      <div class="flex flex-col gap-4 w-[80%]">
        <a href="../perfil-visualizar.html"
          class="w-full bg-white border-2 border-blue-900 rounded-md text-center py-2 hover:text-blue-900 hover:font-medium">Perfil</a>
        <a onclick="redirecionar()"
          class="w-full bg-white border-4 border-amber-500 rounded-md text-center py-2 hover:text-blue-900 hover:font-medium"
          style="cursor:pointer;">Dashboard</a>
        <div class="w-full bg-blue-950 text-white rounded-md text-center px-4 py-2 mt-auto cursor-pointer"
          onclick="limparSessao()"><a href="../index.html" class="no-underline text-white">
            <h3 class="m-0 p-0">Sair</h3>
          </a></div>
      </div>
    </div>

    <!-- CONTEÚDO -->
    <div class="flex-1 ml-[250px] p-6">
      <div class="flex items-center justify-between">
        <h1 class="tituloLote">Saúde dos Componentes</h1>
        <button class="btnVoltar" onclick="window.location.href='/dashboard/dashboardEngenheiroQualidade.html'">Escolher
          Lote</button>
      </div>

      <!-- KPIs -->
      <div class="grid grid-cols-3 gap-6 my-6">
        <div
          class="group relative bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500 flex flex-col justify-between hover:-translate-y-1 transition-transform duration-300">
          <h2 class="font-bold text-xl text-blue-900">Uso Mediana da CPU</h2>
          <p id="kpi_cpu" class="text-3xl font-bold text-blue-700">--%</p>
        </div>

        <div
          class="group relative bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500 flex flex-col justify-between hover:-translate-y-1 transition-transform duration-300">
          <h2 class="font-bold text-xl text-blue-900">Uso Mediana da RAM</h2>
          <p id="kpi_ram" class="text-3xl font-bold text-blue-700">--%</p>
        </div>

        <div
          class="group relative bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500 flex flex-col justify-between hover:-translate-y-1 transition-transform duration-300">
          <h2 class="font-bold text-xl text-blue-900">Uso do Disco</h2>
          <p id="kpi_disco" class="text-3xl font-bold text-blue-700">--%</p>
        </div>
      </div>

      <!-- gráficos -->
      <div class="grid grid-cols-2 gap-6">
        <div class="bg-white shadow-md p-6 rounded-lg">
          <h3 class="font-bold mb-4">Saúde Geral dos Componentes</h3>
          <div id="gaugeChart"></div>
        </div>
        <div class="bg-white shadow-md p-6 rounded-lg">
          <h3 class="font-bold mb-4">Comparação da Saúde dos Componentes</h3>
          <canvas id="componentComparisonChart"></canvas>
        </div>
      </div>

      <div class="bg-white shadow-md p-6 rounded-lg mt-6">
        <h3 class="font-bold mb-4">Evolução da Saúde (Últimos dias)</h3>
        <canvas id="healthEvolutionChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    // ============================
    // CONFIG
    // ============================
    const URL_JSON = "https://bucket-client-navix.s3.us-east-1.amazonaws.com/dashMediana/2025/RelatorioGeral.json";
    const URL_JSON_ALERTA = "https://bucket-client-navix.s3.us-east-1.amazonaws.com/dashAlertas/Ultimos7Dias/Relatorio-Ultimos7Dias.json";

    // charts refs
    let chartComparison = null;
    let chartEvolution = null;
    let apexChartInstance = null;

    // ============================
    // Encontrar lote dentro de um objeto 'lote' procurando por várias chaves
    // ============================
    function matchesId(loteObj, idLote) {
      if (!loteObj) return false;
      const idStr = String(idLote);
      // cheque várias propriedades comuns
      const candidates = [
        loteObj.idLote,
        loteObj.id,
        loteObj.Lote,
        loteObj.codigo_lote,
        loteObj.codigo,
        loteObj.lote // etc
      ];
      return candidates.some(c => c !== undefined && c !== null && String(c) === idStr);
    }

    function findLoteInDay(diaObj, idLote) {
      if (!diaObj) return null;
      if (Array.isArray(diaObj.lotes)) {
        for (const l of diaObj.lotes) {
          if (matchesId(l, idLote)) return l;
        }
      }
      // fallback: maybe diaObj itself has medidas para o lote (sem array)
      if (matchesId(diaObj, idLote)) return diaObj;
      return null;
    }

    // ============================
    // LER LOTE SELECIONADO
    // ============================
    function getSelectedLoteId() {
      const id = localStorage.getItem('lote') || sessionStorage.getItem('lote') || null;
      if (!id) return null;
      return String(id);
    }

    // ============================
    // KPIs: usa JSON de mediana
    // ============================
    async function carregarKPIs(idLote) {
      try {
        const res = await fetch(URL_JSON);
        const json = await res.json();
        // Suporta arrays ou estrutura direta
        let dias = [];
        if (Array.isArray(json)) {
          // formato que você já tinha: json[0].dias
          if (json.length > 0 && Array.isArray(json[0].dias)) {
            dias = json[0].dias;
          } else if (Array.isArray(json.dias)) {
            dias = json.dias;
          }
        } else if (Array.isArray(json.dias)) {
          dias = json.dias;
        } else if (Array.isArray(json[0]?.dias)) {
          dias = json[0].dias;
        }

        const arrCpu = [], arrRam = [], arrDisco = [];
        for (const dia of dias) {
          const lote = findLoteInDay(dia, idLote);
          // tenta pegar valores no lote, se não achar pega no dia
          const cpuVal = lote ? (lote.cpu ?? lote.cpuMediana ?? lote.cpu_median ?? null) : (dia.cpu ?? dia.cpuMediana ?? null);
          const ramVal = lote ? (lote.ram ?? lote.ramMediana ?? lote.ram_median ?? null) : (dia.ram ?? dia.ramMediana ?? null);
          const discoVal = lote ? (lote.disco ?? lote.discoMediana ?? lote.disco_median ?? null) : (dia.disco ?? dia.discoMediana ?? null);

          if (cpuVal !== null && cpuVal !== undefined) arrCpu.push(Number(cpuVal));
          if (ramVal !== null && ramVal !== undefined) arrRam.push(Number(ramVal));
          if (discoVal !== null && discoVal !== undefined) arrDisco.push(Number(discoVal));
        }

        // função mediana / fallback: se vazio -> 0
        function median(arr) {
          if (!arr || arr.length === 0) return 0;
          arr.sort((a, b) => a - b);
          const mid = Math.floor(arr.length / 2);
          if (arr.length % 2 === 0) return Math.round((arr[mid - 1] + arr[mid]) / 2);
          return Math.round(arr[mid]);
        }

        const kpiCpu = median(arrCpu);
        const kpiRam = median(arrRam);
        const kpiDisco = median(arrDisco);

        document.getElementById('kpi_cpu').innerText = `${kpiCpu}%`;
        document.getElementById('kpi_ram').innerText = `${kpiRam}%`;
        document.getElementById('kpi_disco').innerText = `${kpiDisco}%`;

      } catch (err) {
        console.error("Erro carregar KPIs:", err);
      }
    }

    // ============================
    // GRÁFICOS: usa JSON de alertas
    // ============================
    async function carregarGraficos(idLote) {
      try {
        const res = await fetch(URL_JSON_ALERTA);
        const json = await res.json();
        const dias = json.dias ?? json.Dias ?? json;

        // pega lote do primeiro dia (se existir) buscando por id compatível
        const primeiroDia = Array.isArray(dias) && dias.length > 0 ? dias[0] : null;
        let lotePrimeiroDia = findLoteInDay(primeiroDia, idLote) || (primeiroDia?.lotes?.[0] ?? primeiroDia);

        // busca valores críticos
        const cpuCriticoRaw = Number(lotePrimeiroDia?.cpuCritico ?? lotePrimeiroDia?.cpu ?? 0);
        const ramCriticoRaw = Number(lotePrimeiroDia?.ramCritico ?? lotePrimeiroDia?.ram ?? 0);
        const discoCriticoRaw = Number(lotePrimeiroDia?.discoCritico ?? lotePrimeiroDia?.disco ?? 0);

        const cpuCritico = cpuCriticoRaw * 0.5;
        const ramCritico = ramCriticoRaw * 0.5;
        const discoCritico = discoCriticoRaw * 0.5;

        const saudeGeral = Math.max(0, 100 - (cpuCritico + ramCritico + discoCritico));
        const saudeCpu = Math.max(0, 100 - cpuCritico);
        const saudeRam = Math.max(0, 100 - ramCritico);
        const saudeDisco = Math.max(0, 100 - discoCritico);

        // gauge Apex
        const gaugeOptions = {
          series: [saudeGeral],
          chart: { height: 260, type: "radialBar" },
          plotOptions: {
            radialBar: {
              startAngle: -135, endAngle: 135, hollow: { size: "60%" },
              dataLabels: { value: { fontSize: "28px", color: "#1e3a8a", formatter: val => val + "%" } },
              track: { background: "#d1d5db" }
            }
          },
          colors: ["#F7D917"]
        };
        // destrói anterior
        if (apexChartInstance) { try { apexChartInstance.destroy(); } catch (e) { } }
        apexChartInstance = new ApexCharts(document.querySelector("#gaugeChart"), gaugeOptions);
        apexChartInstance.render();

        // comparação (Chart.js)
        const ctx = document.getElementById('componentComparisonChart').getContext('2d');
        if (chartComparison) { chartComparison.destroy(); chartComparison = null; }
        chartComparison = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['CPU', 'RAM', 'Disco'],
            datasets: [{ label: 'Saúde (%)', data: [saudeCpu, saudeRam, saudeDisco] }]
          },
          options: { scales: { y: { beginAtZero: true, max: 100 } } }
        });

        // evolução (por dia)
        const labels = [];
        const cpuArr = [], ramArr = [], discoArr = [];
        if (Array.isArray(dias)) {
          for (let i = 0; i < dias.length; i++) {
            const dia = dias[i];
            labels.push(dia.data ?? `Dia ${i + 1}`);
            const loteDia = findLoteInDay(dia, idLote) || (dia.lotes?.[0] ?? dia);
            const cpuVal = Number(loteDia?.cpuCritico ?? loteDia?.cpu ?? 0);
            const ramVal = Number(loteDia?.ramCritico ?? loteDia?.ram ?? 0);
            const discoVal = Number(loteDia?.discoCritico ?? loteDia?.disco ?? 0);
            cpuArr.push(Math.max(0, 100 - (cpuVal * 0.5)));
            ramArr.push(Math.max(0, 100 - (ramVal * 0.5)));
            discoArr.push(Math.max(0, 100 - (discoVal * 0.5)));
          }
        }

        // destruir/plotar evolução
        const ctx2 = document.getElementById('healthEvolutionChart').getContext('2d');
        if (chartEvolution) { chartEvolution.destroy(); chartEvolution = null; }
        chartEvolution = new Chart(ctx2, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'CPU', data: cpuArr, fill: false, borderWidth: 2, tension: 0.3 },
              { label: 'RAM', data: ramArr, fill: false, borderWidth: 2, tension: 0.3 },
              { label: 'Disco', data: discoArr, fill: false, borderWidth: 2, tension: 0.3 }
            ]
          },
          options: { scales: { y: { beginAtZero: true, max: 100 } } }
        });

      } catch (err) {
        console.error("Erro carregar gráficos:", err);
      }
    }

    // ============================
    // Inicialização
    // ============================
    document.addEventListener("DOMContentLoaded", () => {
      // preencher nome/cargo se existir
      const nomeEmpresa = sessionStorage.getItem("nome_ss");
      const cargo = sessionStorage.getItem("cargo_ss");
      const el = document.getElementById("nomeProfissao");
      if (el) el.innerHTML = `<p class="font-bold text-blue-900">${nomeEmpresa ?? ''}</p><p class="mb-4 text-blue-900">Cargo: ${cargo ?? ''}</p>`;

      const idLote = getSelectedLoteId();
      if (!idLote) {
        Swal.fire({ icon: 'warning', title: 'Nenhum lote selecionado', text: 'Escolha um lote primeiro.' });
        return;
      }

      // atualiza título com id
      const titulo = document.querySelector('.tituloLote');
      if (titulo) titulo.innerText = `Saúde dos Componentes — Lote ${idLote}`;

      // carregar KPIs + gráficos
      carregarKPIs(idLote);
      carregarGraficos(idLote);
    });
  </script>
</body>

</html>