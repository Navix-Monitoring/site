<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lote</title>
    <link rel="icon" href="../assets/navix-logo.jpg">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://kit.fontawesome.com/6921956092.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="../css/dashKeniti.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    <script src="../js/sessao.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@sgratzl/chartjs-chart-boxplot"></script>
    <link href='https://cdn.boxicons.com/fonts/basic/boxicons.min.css' rel='stylesheet'>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-chart-box-and-violin-plot@4.2.3/dist/chartjs-chart-boxplot.min.js"></script>
</head>

<body>

    <div class="flex flex-row w-full">
        <div
            class="min-h-screen w-[250px] flex flex-col items-center bg-slate-100 py-6 shadow-2xl shadow-slate-350 fixed top-0 left-0">
            <img src="../assets/img/Logo.png" class="w-[120px] h-[60px] mb-10">
            <div id="imagemUsuarioNavbar">
                <div class="rounded-md w-20 h-20 mb-2"
                    style="background-image: url(../assets/img/foto-usuario.png); background-size: cover; background-repeat: no-repeat; background-position: center;">
                </div>
            </div>
            <div id="nomeProfissao" class="text-center mb-6"></div>
            <div class="flex flex-col gap-4 w-[80%]">
                <a href="../perfil-visualizar.html"
                    class="w-full bg-white border-2 border-blue-900 rounded-md text-center py-2 hover:text-blue-900 hover:font-medium">
                    Perfil
                </a>
                <a
                    class="w-full bg-white border-4 border-amber-500 rounded-md text-center py-2 hover:text-blue-900 hover:font-medium">
                    Dashboard
                </a>
                <a href="../admin.html" id="adm-only"
                    class="w-full bg-white border-2 border-blue-900 rounded-md text-center py-2 hover:text-blue-900 hover:font-medium">
                    Cadastrar Funcionários
                </a>
                <a href="./cadastroVeiculos.html"
                    class="w-full bg-white border-2 border-blue-900 rounded-md text-center py-2 hover:text-blue-900 hover:font-medium">
                    Gerenciar Frota
                </a>
                <div class="w-full bg-blue-950 text-white rounded-md text-center px-4 py-2 mt-auto cursor-pointer"
                    onclick="limparSessao()">
                    <a href="../index.html" class="no-underline text-white">
                        <h3 class="m-0 p-0">Sair</h3>
                    </a>
                </div>
            </div>
        </div>

        <div class="flex flex-col ml-[250px] w-full p-8">
            <a class="btnVoltar" onclick="localStorage.clear(); redirecionar();">
                <div style="margin-bottom: 20px; display: flex; align-items: center; font-size: 30px;">
                    <i class='bx bx-arrow-left-stroke'></i>
                    <h3>Voltar</h3>
                </div>
            </a>

            <div class="topoTitulo">
                <h1 class="tituloLote" id="tituloLote">Análise de Desempenho - Modelo Keniti</h1>
                <div class="kpiData">Última Atualização: <span id="dataHora"></span></div>
            </div>

            <main class="card">
                <div class="kpi-unified-card">
                    <h2 class="kpi-section-title">PIORES LOTES - MEDIANAS</h2>
                    <div class="kpi-row">
                    <div class="kpi-column">
                        <span class="kpi-title-top">Uso da CPU</span>
                        <h2 id="kpiCPUlote" class="kpi-batch-name">Lote 1</h2>
                        <span class="kpi-subtext"><span id="kpiCPU" class="kpi-valor">v1%</span></span>
                    </div>
                    <div class="kpi-column">
                        <span class="kpi-title-top">Processos abertos</span>
                        <h2 id="kpiProcessoslote" class="kpi-batch-name">Lote 2</h2>
                        <span class="kpi-subtext"><span id="kpiProcessos" class="kpi-valor">v2</span></span>
                    </div>
                    <div class="kpi-column">
                        <span class="kpi-title-top">Uso de disco</span>
                        <h2 id="kpiDiscolote" class="kpi-batch-name">Lote 3</h2>
                        <span class="kpi-subtext"><span id="kpiDisco" class="kpi-valor">v3%</span></span>
                    </div>
                    <div class="kpi-column">
                        <span class="kpi-title-top">Temperatura CPU</span>
                        <h2 id="kpiTemplote" class="kpi-batch-name">Lote 4</h2>
                        <span class="kpi-subtext"><span id="kpiTemp" class="kpi-valor">v4°C</span></span>
                    </div>
                    </div>
                </div>
                <section class="dashboard-card">
                    <div class="dashboard-card-header"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2>Análise 5 Piores Lotes</h2>
                        <select id="escolhaVisu" class="escolhaVisu">
                            <option value="cpu">CPU</option>
                            <option value="temp">Temp</option>
                            <option value="ram">RAM</option>
                            <option value="disco">Disco</option>
                            <option value="processo">Processo</option>
                        </select>
                    </div>

                    <div class="chart-container-integrated">
                        <canvas id="evolucao"></canvas>
                    </div>

                </section>

                <div class="container">
                    <div class="container-filho">
                        <div class="chart-container-alert">
                            <canvas id="relacao"></canvas>
                        </div>
                    </div>
                    <div class="container-filho" id="containerCarga">
                        <div class="chart-container-alert">
                            <canvas id="carga"></canvas>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
</body>

</html>
<script src="../js/redirecionar.js"></script>
<script>

    function atualizarDataHora() {
        const agora = new Date();
        const dataHoraFormatada = agora.toLocaleString("pt-BR");
        document.getElementById("dataHora").textContent = dataHoraFormatada;
    }

    atualizarDataHora();


    function carregarUsuarioSessao() {
        var imagemUsuarioNavbar = document.getElementById("imagemUsuarioNavbar");
        var fotoUrl = sessionStorage.getItem("imagem");
        if (imagemUsuarioNavbar && fotoUrl) {
            imagemUsuarioNavbar.innerHTML = `
            <div class="rounded-md w-20 h-20 mb-2"
                style="background-image: url(${fotoUrl}); background-size: cover; background-repeat: no-repeat; background-position: center;">
            </div>
            `;
        }

        var nomeEmpresa = sessionStorage.getItem("nome_ss");
        var cargo = sessionStorage.getItem("cargo_ss");
        var nomeProfissao = document.getElementById("nomeProfissao");

        if (nomeProfissao) {
            nomeProfissao.innerHTML = `
                <p class="font-bold text-blue-900">${nomeEmpresa || "Usuário"}</p>
                <p class="mb-4 text-blue-900">Cargo: ${cargo || "Não definido"}</p>
            `;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {

        var kpicpu_lote = document.getElementById("kpiCPUlote").innerHTML = "Lote 1";
        var kpiproce_lote = document.getElementById("kpiProcessoslote").innerHTML = "Lote 2";
        var kpidisc_lote = document.getElementById("kpiDiscolote").innerHTML = "Lote 3";
        var kpitemp_lote = document.getElementById("kpiTemplote").innerHTML = "Lote 4";
        var kpicpu_valor = document.getElementById("kpiCPU").innerHTML = "v1%";
        var kpiproce_valor = document.getElementById("kpiProcessos").innerHTML = "v2";
        var kpidisc_valor = document.getElementById("kpiDisco").innerHTML = "v3%";
        var kpitemp_valor = document.getElementById("kpiTemp").innerHTML = "v4°C";

        const COR_CONTEXTO = '#B0B0B0';

        function prepararDatasetsDestaque(lotes, piorLoteLabel) {
            const datasetsFinais = [];

            lotes.forEach(loteOriginal => {
                const corDesteLote = (loteOriginal.label === piorLoteLabel)
                    ? loteOriginal.borderColor
                    : COR_CONTEXTO;

                datasetsFinais.push({
                    label: loteOriginal.label,
                    data: loteOriginal.data,
                    borderColor: corDesteLote,
                    backgroundColor: corDesteLote,
                    fill: false,
                    borderRadius: 6,
                    categoryPercentage: 0.8,
                    barPercentage: 0.85,
                });
            });

            return datasetsFinais;
        }

        function encontrarPiorLote(lotes) {
            let piorLoteLabel = null;
            let maiorMedia = -Infinity;

            lotes.forEach(lote => {
                let soma = 0;
                for (let i = 0; i < lote.data.length; i++) {
                    soma += lote.data[i];
                }
                const media = soma / lote.data.length;

                if (media > maiorMedia) {
                    maiorMedia = media;
                    piorLoteLabel = lote.label;
                }
            });
            return piorLoteLabel;
        }

        const DADOS_RELACAO = {
            cpu: {
                semana: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
                    titulo: 'Visão Pior Lote: CPU (%) x Temp. CPU (°C)',
                    cpu: [3, 5, 2, 4, 6, 3, 4],
                    temp: [5, 7, 9, 6, 8, 4, 5]
                }
            },
            temp: {
                semana: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
                    titulo: 'Visão Pior Lote: Temp. CPU (°C) x CPU (%)',
                    temp: [3, 5, 2, 4, 6, 3, 4],
                    cpu: [5, 7, 9, 6, 8, 4, 5]
                }
            },
            ram: {
                semana: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
                    titulo: 'Visão Pior Lote: RAM (%) x Qtd. Média de Processos',
                    ram: [3, 5, 2, 4, 6, 3, 4],
                    processos: [5, 7, 9, 6, 8, 4, 5]
                }
            },
            disco: {
                semana: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
                    titulo: 'Visão Agregada: Disco (%) x Qtd. Média de Processos',
                    disco: [3, 5, 2, 4, 6, 3, 4],
                    processos: [5, 7, 9, 6, 8, 4, 5]
                }
            },
            processo: {
                semana: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
                    titulo: 'Visão Agregada: Qtd. Média de Processos x Disco (%)',
                    processos: [3, 5, 2, 4, 6, 3, 4],
                    disco: [5, 7, 9, 6, 8, 4, 5]
                }
            }
        };

        const DADOS_EVOLUCAO = {
            cpu: {
                semana: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
                    titulo: 'Evolução Uso CPU',
                    eixoY: 'Uso CPU (%)',
                    lotes: [
                        { label: 'Lote A048', data: [88, 85, 87, 82, 90, 88, 86], borderColor: '#0d4299' },
                        { label: 'Lote A012', data: [85, 82, 83, 80, 85, 84, 83], borderColor: '#0d4299' },
                        { label: 'Lote A031', data: [82, 80, 81, 79, 83, 82, 81], borderColor: '#0d4299' },
                        { label: 'Lote A009', data: [81, 79, 80, 78, 82, 80, 79], borderColor: '#0d4299' },
                        { label: 'Lote A055', data: [79, 78, 77, 76, 80, 79, 78], borderColor: '#0d4299' }
                    ]
                }
            },
            temp: {
                semana: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
                    titulo: 'Evolução Temperatura',
                    eixoY: 'Temp. (°C)',
                    lotes: [
                        { label: 'Lote A048', data: [75, 72, 77, 73, 75, 78, 76], borderColor: '#0d4299' },
                        { label: 'Lote A012', data: [68, 70, 69, 71, 68, 67, 70], borderColor: '#0d4299' },
                        { label: 'Lote A031', data: [72, 73, 71, 70, 74, 72, 73], borderColor: '#0d4299' },
                        { label: 'Lote A009', data: [65, 66, 64, 67, 68, 65, 66], borderColor: '#0d4299' },
                        { label: 'Lote A055', data: [66, 68, 67, 65, 69, 67, 68], borderColor: '#0d4299' }
                    ]
                }
            },
            ram: {
                semana: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
                    titulo: 'Evolução RAM',
                    eixoY: 'Uso RAM (%)',
                    lotes: [
                        { label: 'Lote A012', data: [72, 70, 71, 73, 75, 74, 72], borderColor: '#0d4299' },
                        { label: 'Lote A048', data: [70, 68, 69, 71, 72, 70, 71], borderColor: '#0d4299' },
                        { label: 'Lote A031', data: [65, 66, 64, 67, 68, 65, 66], borderColor: '#0d4299' },
                        { label: 'Lote A009', data: [40, 42, 41, 39, 43, 40, 41], borderColor: '#0d4299' },
                        { label: 'Lote A055', data: [38, 39, 37, 40, 41, 38, 39], borderColor: '#0d4299' }
                    ]
                }
            },
            disco: {
                semana: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
                    titulo: 'Evolução Uso de Disco',
                    eixoY: 'Uso Disco (%)',
                    lotes: [
                        { label: 'Lote A012', data: [98, 97, 98, 99, 98, 97, 98], borderColor: '#0d4299' },
                        { label: 'Lote A031', data: [95, 96, 94, 95, 96, 95, 94], borderColor: '#0d4299' },
                        { label: 'Lote A048', data: [50, 51, 49, 52, 50, 51, 50], borderColor: '#0d4299' },
                        { label: 'Lote A009', data: [30, 31, 29, 32, 30, 31, 30], borderColor: '#0d4299' },
                        { label: 'Lote A055', data: [25, 26, 24, 27, 25, 26, 25], borderColor: '#0d4299' }
                    ]
                }
            },
            processo: {
                semana: {
                    labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'],
                    titulo: 'Evolução de Processos',
                    eixoY: 'Qtd. Processos',
                    lotes: [
                        { label: 'Lote A012', data: [300, 310, 290, 305, 295, 300, 310], borderColor: '#0d4299' },
                        { label: 'Lote A031', data: [300, 290, 310, 300, 305, 295, 300], borderColor: '#0d4299' },
                        { label: 'Lote A055', data: [300, 305, 295, 310, 290, 300, 305], borderColor: '#0d4299' },
                        { label: 'Lote A009', data: [230, 235, 225, 240, 230, 235, 225], borderColor: '#0d4299' },
                        { label: 'Lote A048', data: [120, 125, 115, 130, 120, 125, 115], borderColor: '#0d4299' }
                    ]
                }
            }
        };

        const DADOS_CARGA = {
            cpu: {
                labels: ['CPU'],
                data: [
                    [10, 8, 3]
                ],
                titulo: 'Uso do sistema - CPU'
            },
            ram: {
                labels: ['RAM'],
                data: [
                    [9, 3, 7]
                ],
                titulo: 'Uso do sistema - RAM'
            },
            disco: {
                labels: ['Disco'],
                data: [
                    [12, 1, 6]
                ],
                titulo: 'Uso do sistema - Disco'
            },
            temp: {
                labels: ['Temperatura'],
                data: [
                    [60, 65, 70, 72, 78]
                ],
                titulo: 'Uso do sistema - Temperatura'
            },
            processo: {
                labels: ['Processos'],
                data: [
                    [150, 210, 240, 270, 310]
                ],
                titulo: 'Uso do sistema - Processos'
            }
        };

        const LIMITES = { cpu: 85, ram: 80, disco: 90, temp: 70, processo: 250 };

        function atualizarGraficos() {
            const metrica = document.getElementById('escolhaVisu').value;

            const containerCarga = document.getElementById('containerCarga');

            // Atualizando gráfico relacao
            if (graficoRelacao) {
                const dados = DADOS_RELACAO[metrica].semana;

                graficoRelacao.data.labels = dados.labels;
                graficoRelacao.options.plugins.title.text = dados.titulo;

                if (metrica === 'cpu') {
                    graficoRelacao.data.datasets[0].label = 'CPU';
                    graficoRelacao.data.datasets[0].data = dados.cpu;
                    graficoRelacao.data.datasets[1].label = 'Temperatura';
                    graficoRelacao.data.datasets[1].data = dados.temp;
                } else if (metrica === 'temp') {
                    graficoRelacao.data.datasets[0].label = 'Temperatura';
                    graficoRelacao.data.datasets[0].data = dados.temp;
                    graficoRelacao.data.datasets[1].label = 'CPU';
                    graficoRelacao.data.datasets[1].data = dados.cpu;
                } else if (metrica === 'ram') {
                    graficoRelacao.data.datasets[0].label = 'RAM';
                    graficoRelacao.data.datasets[0].data = dados.ram;
                    graficoRelacao.data.datasets[1].label = 'Processos';
                    graficoRelacao.data.datasets[1].data = dados.processos;

                } else if (metrica === 'disco') {
                    graficoRelacao.data.datasets[0].label = 'Disco';
                    graficoRelacao.data.datasets[0].data = dados.disco;
                    graficoRelacao.data.datasets[1].label = 'Processos';
                    graficoRelacao.data.datasets[1].data = dados.processos;
                } else if (metrica === 'processo') {
                    graficoRelacao.data.datasets[0].label = 'Processos';
                    graficoRelacao.data.datasets[0].data = dados.processos;
                    graficoRelacao.data.datasets[1].label = 'Disco';
                    graficoRelacao.data.datasets[1].data = dados.disco;
                }
                graficoRelacao.update();
            }

            // Atualizando gráfico Top 5
            if (graficoEvolucao) {
                if (DADOS_EVOLUCAO[metrica].semana) {
                    const dados = DADOS_EVOLUCAO[metrica].semana;

                    const piorLoteLabel = encontrarPiorLote(dados.lotes);
                    const novosDatasets = prepararDatasetsDestaque(dados.lotes, piorLoteLabel);

                    graficoEvolucao.data.datasets = novosDatasets;
                    graficoEvolucao.data.labels = dados.labels;
                    graficoEvolucao.options.plugins.title.text = dados.titulo;
                    graficoEvolucao.options.scales.y.title.text = dados.eixoY;

                    const novoLimite = LIMITES[metrica] || 0;
                    graficoEvolucao.options.plugins.annotation.annotations.linhaIdeal.yMin = novoLimite;
                    graficoEvolucao.options.plugins.annotation.annotations.linhaIdeal.yMax = novoLimite;

                    graficoEvolucao.update();
                } else {
                    console.warn(`Dados não encontrados.`);
                }
            }

            if (graficoCarga && containerCarga) {
                const dados = DADOS_CARGA[metrica];

                graficoCarga.data.labels = dados.labels;
                graficoCarga.data.datasets[0].data = dados.data;
                graficoCarga.options.plugins.title.text = dados.titulo;

                containerCarga.style.display = 'block';
                graficoCarga.update();
            }
            ordenarTabela(metrica);
        }

        const selectEvolucao = document.getElementById('escolhaVisu');

        const ctxRelacao = document.getElementById('relacao');
        const ctxCarga = document.getElementById('carga');
        const ctxEvolucao = document.getElementById('evolucao');

        let graficoRelacao;
        let graficoCarga;
        let graficoEvolucao;

        carregarUsuarioSessao();

        if (typeof verificarCargo === "function") {
            verificarCargo();
        }
        if (typeof listarLotes === "function") {
            listarLotes();
        }

        // Relação 
        if (ctxRelacao) {
            const dadosIniciais = DADOS_RELACAO.cpu.semana;
            graficoRelacao = new Chart(ctxRelacao, {
                type: 'line',
                data: {
                    labels: dadosIniciais.labels,
                    datasets: [
                        { label: 'CPU', data: dadosIniciais.cpu, backgroundColor: 'blue', borderColor: 'blue', fill: false },
                        { label: 'Temperatura', data: dadosIniciais.temp, backgroundColor: 'red', borderColor: 'red', fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: 'black' } },
                        title: { display: true, text: dadosIniciais.titulo, color: 'black', font: { size: 18, weight: 'bold' } }
                    },
                    scales: {
                        x: { stacked: true, ticks: { color: 'black' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: {
                            stacked: true, beginAtZero: true, ticks: { color: 'black' }, grid: { color: 'black' },
                            title: { display: true, text: 'Valor', color: 'black', font: { size: 14 } }
                        }
                    }
                }
            });
        }

        // Evolução Top 5 
        if (ctxEvolucao) {
            const dadosIniciais = DADOS_EVOLUCAO.cpu.semana;

            const piorLoteLabelInicial = encontrarPiorLote(dadosIniciais.lotes);
            const datasetsIniciais = prepararDatasetsDestaque(dadosIniciais.lotes, piorLoteLabelInicial);

            graficoEvolucao = new Chart(ctxEvolucao, {
                type: 'bar',
                data: {
                    labels: dadosIniciais.labels,
                    datasets: datasetsIniciais
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        annotation: {
                            annotations: {
                                linhaIdeal: {
                                    type: 'line',
                                    yMin: 85,
                                    yMax: 85,
                                    borderColor: '#FFAE42',
                                    borderWidth: 2,
                                    borderDash: [10, 5],
                                    label: {
                                        display: true,
                                        content: 'Limite Ideal',
                                        position: 'end',
                                        backgroundColor: '#FFAE42',
                                        color: 'white',
                                    }
                                }
                            }
                        },
                        legend: { position: 'top', labels: { color: 'black' } },
                        title: { display: true, text: dadosIniciais.titulo, color: 'black', font: { size: 18, weight: 'bold' } }
                    },
                    scales: {
                        x: { stacked: false, ticks: { color: 'black' }, grid: { color: 'transparent' } },
                        y: {
                            stacked: false, beginAtZero: true, ticks: { color: 'black' }, grid: { color: '#e9e9e9' },
                            title: { display: true, text: dadosIniciais.eixoY, color: 'black', font: { size: 14 } }
                        }
                    }
                }
            });
        }

        if (ctxCarga) {
            const dadosIniciaisrelacao = DADOS_CARGA.cpu;

            graficoCarga = new Chart(ctxCarga, {
                type: 'boxplot',
                data: {
                    labels: dadosIniciaisrelacao.labels,
                    datasets: [{
                        label: 'Quartil',
                        data: dadosIniciaisrelacao.data,
                        backgroundColor: ['blue'],
                        borderColor: ['black'],
                        outlierBackgroundColor: 'red'
                    }]
                },
                options: {
                    indexAxis: 'x',
                    plugins: {
                        title: { display: true, text: 'Uso do sitema do modelo', color: 'black', font: { size: 18, weight: 'bold' }, padding: { bottom: 20 } },
                        legend: { position: 'top', labels: { color: 'black' } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                color: 'black',
                                font: { size: 14 }
                            }
                        },
                        x: { stacked: false, ticks: { color: 'black' } }
                    }
                }
            });
        }

        selectEvolucao.addEventListener('change', atualizarGraficos);
    });
</script>